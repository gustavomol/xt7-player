' Gambas class file

'Copyright (C) 2007, 2008 Antonio Orefice
' Gambas class file


'PRIVATE InfoTags AS String[] = ["Filename", "Length", "Artist", "Album", "Year", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""]


Private Alternate As Boolean = True
Private Ascendent As Boolean = True

Public MplayerTag As New MplayerClass
Public ColumnIndex As New Collection

Public PTable As New String[0] 'String array, separator for columns = "|@CI=X "
Public SearchTable As New String[0] 'String array, separator for columns = "|@CI=X "
Private SortTable As New String[0] 'copy of ptable sorted by fullpath

Public TableSeparator As String = Chr(8)
Public Loading As Boolean = False

Public FilesToProcess As Integer = 0
Public FilesProcessed As Integer = 0

Private LastSortedField As String = ""

Private RandomArray As New Integer[] 'stores the last successful rolls
'stores the media already player, used to listen the previous media in random mode

Public AlreadyPlayedString As New String[]


Public Sub Init(WithMplayer As Boolean)
  Randomize
  If WithMplayer Then
    MplayerTag.quick = True
    ' MplayerTag.do_play("", "-idle -ao null -vo null -channels 6 -demuxer ogg", TRUE) 'we hack -demuxer ogg here because
    '                                                                                  'of lavf demuxer doesn't report
    '                                                                                  'tags anymore on ogg streams...
    '...but unfortunately, specifiyng a demuxer seems to force it, so mplayer_idle whouldn't be able to get any
    'info on other files... we'll use audiotag for oggs too.
    MplayerTag.do_play("", "-idle -ao null -vo null -channels 6", True)
  Endif
  Columnindex["Filename"] = 0
  Columnindex["Length"] = 1
  Columnindex["Artist"] = 2
  Columnindex["Album"] = 3
  Columnindex["Year"] = 4
  Columnindex["Track"] = 5
  Columnindex["Title"] = 6
  Columnindex["Genre"] = 7
  Columnindex["Comment"] = 8
  Columnindex["Type"] = 9
  Columnindex["Audio Codec"] = 10
  Columnindex["Audio Bitrate"] = 11
  Columnindex["Audio Rate"] = 12
  Columnindex["Channels"] = 13
  Columnindex["Video Codec"] = 14
  Columnindex["Video Bitrate"] = 15
  Columnindex["Fps"] = 16
  Columnindex["Width"] = 17
  Columnindex["Height"] = 18
  Columnindex["Full Path"] = 19
  Columnindex["File Size"] = 20
  Columnindex["Added on"] = 21
End

Private Sub CheckPlayerAlive()
'will restart mplayer if it is crashed  
  Dim i As Integer
  Dim mymax As Integer = 20
  Dim restart As Boolean = True
  If Not (MplayerTag.ProcessRunningOvr()) Then
    mplayertag = New Mplayerclass
    MplayerTag.do_play("", "-idle -ao null -vo null -channels 6", restart)
    Debug "(Re)starting player"
    Wait 0.5
  Endif
End



Private Function OneOf(one As String, two As String) As String
  If one <> "" Then
    Return one
      Else
    Return two
  Endif
End


Public Sub Load(myplaylist As Gridview, profilename As String)
  Dim filename As String = Profilename & "/" & myplaylist.name & ".txt"
  Dim i As Integer
  Dim Layout As String[]
  Loading = True
  Try PTable = Split(file.Load(filename), "\n")
  PTable.Resize(PTable.count - 1)
  
  If ptable.Count > 0 Then
    If Ptable[0] Like "Layout*" Then
      'load column layout
        Layout = Split(Ptable[0], ";", "", False)
        ptable.Remove(0, 1)
        For i = 1 To layout.count - 1
          myplaylist.Columns[i - 1].w = layout[i]
        Next 'i
    Endif
  Endif
  myplaylist.Rows.count = myplaylist.Rows.count + PTable.count

  InitSearchTable()
  Debug "Load()at: " & Time
End

Public Sub SaveAs(FileName As String)
  Dim MyFile As File
  Dim ext As String
  Dim c As Integer
  Myfile = Open filename For Write Create
  ext = Upper(Myfile.ext(filename))
  If ext = "M3U" Then
      SaveM3u(MyFile)
        Else If ext = "PLS" Then
          SavePls(MyFile)
        Else
          SaveXpl(MyFile)
  Endif
  Close #MyFile
End

Public Sub LoadFile(Filename As String, Grid As Gridview, Optional Appendit As Boolean = False)
  Dim i As Integer
  Dim ext As String
  Loading = True
  Debug "PlaylistClass: Load()at: " & Time
  ext = Upper(file.ext(filename))
  If (Not Appendit) Then Ptable.Resize(0)
  If ext = "M3U" Then
        Try Ptable.Insert(LoadM3u(Filename))
      Else If ext = "PLS" Then
        Try Ptable.Insert(LoadPls(FileName))
      Else
        Try Ptable.Insert(LoadXpl(FileName))
  Endif
  Grid.Rows.count = PTable.count '- 1 '+Grid.Rows.count
  InitSearchTable()
End

Private Function LoadPls(filename As String) As String[]
  'Read a pls playlist, convert it in ptable format and return it
  Dim TempTable As New String[]
  Dim NewPTable As New String[]
  Dim MyCollection As New Collection
  Dim i, NumberOfEntries As Integer
  Dim CurrentLine, Length, name, Path, Size, newrow As String
  Dim ts As String = Chr(8)
  TempTable = Split(file.Load(filename), "\n")
  Length = ""
  name = ""
  Path = ""
  newrow = ""
  'find the number of entries
  i = 0
  Repeat
    currentline = TempTable[i]
    I = I + 1
  Until (i = TempTable.count) Or (Upper(Currentline) Like "NUMBEROFENTRIES=*")
  If Upper(Currentline) Like "NUMBEROFENTRIES=*" Then
    NumberOfEntries = (Split(Currentline, "=")[1])
    If Error Then Return
      Else
    Return
  Endif
  For i = 0 To TempTable.count - 1
    CurrentLine = TempTable[i]
    If Upper(Currentline) Like "FILE*=*" Then
          Path = Replace(Currentline, Split(CurrentLine, "=")[0] & "=", "")
          MyCollection.Add(path, Upper(Split(CurrentLine, "=")[0]))
        Else If Currentline Like "TITLE*=*" Then
          Name = Replace(Currentline, Split(CurrentLine, "=")[0] & "=", "")
          MyCollection.Add(name, Upper(Split(CurrentLine, "=")[0]))
        Else If Currentline Like "LENGTH*=*" Then
          Length = MplayerTag.FormatTime(Replace(Currentline, Split(CurrentLine, "=")[0] & "=", ""))
          MyCollection.Add(length, Upper(Split(CurrentLine, "=")[0]))
    Endif
Next 'i
    

  
  NewPtable.Resize(0)
  For i = 1 To NumberOfEntries
    NewRow = ""
    'Build a ptableRow
      Try size = Stat(MyCollection["FILE" & i]).size
        If Error Then size = "?"
      NewRow = Newrow & ts & "Filename" & ts & MyCollection["TITLE" & i]
      NewRow = Newrow & ts & "Length" & ts & MyCollection["LENGTH" & i]
      NewRow = Newrow & ts & "Type" & ts
      NewRow = Newrow & ts & "Audio Codec" & ts
      NewRow = Newrow & ts & "Audio Bitrate" & ts
      NewRow = Newrow & ts & "Audio Rate" & ts
      NewRow = Newrow & ts & "Channels" & ts
      NewRow = Newrow & ts & "Video Codec" & ts
      NewRow = Newrow & ts & "Video Bitrate" & ts
      NewRow = Newrow & ts & "Fps" & ts
      NewRow = Newrow & ts & "Width" & ts
      NewRow = Newrow & ts & "Height" & ts
      NewRow = Newrow & ts & "Full Path" & ts & MakeRelAbsPath(MyCollection["FILE" & i], filename)
      NewRow = Newrow & ts & "File Size" & ts & Size
      NewRow = Newrow & ts & "Added on" & ts & Now
      NewRow = Newrow & ts & "Album" & ts
      NewRow = Newrow & ts & "Artist" & ts
      NewRow = Newrow & ts & "Title" & ts
      NewRow = Newrow & ts & "Year" & ts
      NewRow = Newrow & ts & "Genre" & ts
      NewRow = Newrow & ts & "Track" & ts
      NewRow = Newrow & ts & "Comment" & ts
      NewPtable.Add(NewRow)
  Next 'i
  
  Return NewPtable
  
End


Private Function SavePls(MyFile As File) As String[]
  Dim r As Integer
  Dim MyRow, Length, Name, Path As String
  Print #Myfile, "[playlist]" 'pls start marker
  Print #Myfile, "NumberOfEntries=" & PTable.Count
  Print #Myfile
  For r = 0 To PTable.Count - 1
    MyRow = Ptable[r]
    Length = MplayerTag.DeFormatTime(GetValue(MyRow, "Length"))
    Name = GetValue(MyRow, "FileName")
    Path = GetValue(MyRow, "Full Path")
    Print #Myfile, "File" & CStr(r + 1) & "=" & path
    Print #Myfile, "Title" & CStr(r + 1) & "=" & Name
    Print #Myfile, "Length" & CStr(r + 1) & "=" & Length
    Print #Myfile
    Print #MyFile, "Version = 2"
  Next 'r
End


Private Function MakeRelAbsPath(stream As String, RootPath As String) As String
  'will return an absolute path starting from a relativeOne (if any)
  'or return the same path
  'eg: MakeRelAbsPath("mymusic/1.mp3","/tmp/mypls.m3u") == "/tmp////mymusic/1.mp3"
  'eg: MakeRelAbsPath("/mymusic/1.mp3","/tmp/mypls.m3u") == "/mymusic/1.mp3"
  'eg: MakeRelAbsPath("http://www.mysite.it/mymusic/1.mp3","/tmp/mypls.m3u") == "http://www.mysite.it/mymusic/1.mp3"
 
 While Stat(rootpath).type = gb.link  'traceback sym links
    rootpath = Stat(rootpath).link
 Wend
  rootpath = file.Dir(rootpath)

  If ISURI(stream) Or (Left(stream) = "/") Then
    Return stream
      Else
    Return RootPath & "////" & stream
  Endif
End


Private Function LoadM3U(filename As String) As String[]
  'Read an (extended) m3u playlist, convert it in ptable format and return it
  Dim TempTable As New String[]
  Dim NewPTable As New String[]
  Dim i As Integer
  Dim CurrentLine, Length, name, Path, Size, newrow As String
  Dim ts As String = Chr(8)
  TempTable = Split(file.Load(filename), "\n", "", True)
  name = ""
  Path = ""
  newrow = ""
  For i = 0 To TempTable.count - 1
    CurrentLine = Trim(TempTable[i])
    If Not (Trim(currentline) = "") Then
      If Not (CurrentLine = "#EXTM3U") Then
        If Upper(CurrentLine) Like "#EXTINF:*" Then
          Length = MplayerTag.FormatTime(Split(Split(CurrentLine, ",")[0], ":")[1])
          Name = Replace(Currentline, Split(CurrentLine, ",")[0] & ",", "")
            Else
          Path = MakeRelAbsPath(CurrentLine, filename)
          Try Size = Stat(Path).Size
          If Error Then Size = "?"
          'Build a ptableRow
            NewRow = Newrow & ts & "Filename" & ts & name
            NewRow = Newrow & ts & "Length" & ts & Length
            NewRow = Newrow & ts & "Type" & ts
            NewRow = Newrow & ts & "Audio Codec" & ts
            NewRow = Newrow & ts & "Audio Bitrate" & ts
            NewRow = Newrow & ts & "Audio Rate" & ts
            NewRow = Newrow & ts & "Channels" & ts
            NewRow = Newrow & ts & "Video Codec" & ts
            NewRow = Newrow & ts & "Video Bitrate" & ts
            NewRow = Newrow & ts & "Fps" & ts
            NewRow = Newrow & ts & "Width" & ts
            NewRow = Newrow & ts & "Height" & ts
            NewRow = Newrow & ts & "Full Path" & ts & Path
            NewRow = Newrow & ts & "File Size" & ts & Size
            NewRow = Newrow & ts & "Added on" & ts & Now
            NewRow = Newrow & ts & "Album" & ts
            NewRow = Newrow & ts & "Artist" & ts
            NewRow = Newrow & ts & "Title" & ts
            NewRow = Newrow & ts & "Year" & ts
            NewRow = Newrow & ts & "Genre" & ts
            NewRow = Newrow & ts & "Track" & ts
            NewRow = Newrow & ts & "Comment" & ts
            
            NewPtable.Add(NewRow)
            
            Length = ""
            name = ""
            Path = ""
            newrow = ""
        Endif
      Endif
    Endif
  Next 'i
  NewPTable.Resize(NewPTable.count)
  Return NewPtable
End


Private Sub Savem3u(MyFile As File)
  Dim r As Integer
  Dim MyRow, Length, Name, Path As String
  Print #Myfile, "#EXTM3U" 'm3u start marker
  For r = 0 To PTable.Count - 1
    MyRow = Ptable[r]
    Length = MplayerTag.DeFormatTime(GetValue(MyRow, "Length"))
    Name = GetValue(MyRow, "FileName")
    Path = GetValue(MyRow, "Full Path")
  'Example: #EXTINF: 307, Jingle bells
    Print #MyFile, "#EXTINF:" & Length & "," & Name
    Print #MyFile, Path
  Next 'c
End

Private Function LoadXpl(filename As String) As String[]
  Dim Ptable As String[]
  PTable = Split(file.Load(filename), "\n")
  If ptable.count = 0 Then Return
  If Not (ptable[0] Like "*" & TableSeparator & "*") Then Return
  PTable.Resize(PTable.count - 1)
  Return Ptable
End

Private Sub SaveXpl(MyFile As File)
  Dim r As Integer
  For r = 0 To PTable.Count - 1
    Print #Myfile, PTable[r]
  Next 'c
End










Public Sub Save(myplaylist As Gridview, ProfileName As String)
  Dim filename As String = Profilename & "/" & myplaylist.name & ".txt"
  Dim MyFile As File
  Dim i, r, c As Integer
  Dim layout As String = "Layout"
  Myfile = Open filename For Write Create
  'write ptable layout
    For i = 0 To myplaylist.Columns.Count - 1
      Layout = Layout & ";" & myplaylist.Columns[i].w
    Next 'i
    Print #Myfile, Layout
  
  For r = 0 To PTable.Count - 1
  'FOR r = 1 TO PTable.Count - 1
    Print #Myfile, PTable[r]
  Next 'c
  Close #MyFile
End


Private Sub InitSearchTable()
  Dim i As Integer
  SearchTable.Resize(0)
  'fill searchtable from ptable
    For i = 0 To PTable.Count - 1
      SearchTable.Add(PTable[i])
    Next 'i
End



Public Function GetValue(TableRow As String, Field As String) As String
  Dim Startpos, MidPos, EndPos As Integer
  Dim myvalue As String
  StartPos = InStr(TableRow, TableSeparator & Field)
  MidPos = InStr(TableRow, TableSeparator, StartPos + 2)
  EndPos = InStr(TableRow, TableSeparator, Midpos + 1)
  Return Mid(TableRow, midpos + 1, Endpos - (midpos + 1))
End

' PUBLIC FUNCTION CellValue(LibraryGrid AS gridview, R AS Integer, C AS Integer) AS String
'   DIM ColumnCaption AS String = LibraryGrid.Columns[c].text
'   DIM tablerow AS String
'   DIM GotValue AS String
'   DIM TextW, CaptionW AS Integer
'   TRY tablerow = SearchTable[r]
'   
'   'IF librarygrid.columns[c].w <> 10 THEN librarygrid.columns[c].w = 10
'   GotValue = GetValue(tablerow, ColumnCaption)
'   TextW = Librarygrid.Font.TextWidth(gotvalue)
'   
'      'ShutResultGrid.Columns[0].text = ("Name")
' 
'   IF (TextW > Librarygrid[R, C].W) AND (TextW > 100) THEN 
'     Librarygrid.columns[C].W = TextW + 1
'  '   DEBUG "GotValue= " & Gotvalue
'  '   DEBUG "TextW= " & TextW
'       ELSE IF textW <= 100 THEN 
'         Librarygrid.columns[C].W = 100
'   ENDIF
'   WAIT 0.001
'   RETURN GotValue
'   
' END

Public Function CellValue(LibraryGrid As Gridview, R As Integer, C As Integer) As String
  Dim ColumnCaption As String = LibraryGrid.Columns[c].text
  Dim tablerow As String
  Try tablerow = SearchTable[r]
  
  'IF librarygrid.columns[c].w <> 10 THEN librarygrid.columns[c].w = 10

  Return GetValue(tablerow, ColumnCaption)
  
End


Public Sub FillColumns(LibraryGrid As Gridview, r As Integer)
  Dim TagsAndValues As String[] = Split(SearchTable[r], TableSeparator)
  Dim DstCol As Integer 'eg 0
  Dim Tag As String 'eg FileName
  Dim Value As String 'eg my.mp3
  Dim i As Integer

  'DIM StartTime AS Float = Timer
  'DIM DiffTime AS Float3

  For i = 0 To TagsAndValues.count - 2
    Tag = TagsAndValues[i + 1]
    Value = TagsAndValues[i + 2]
    DstCol = ColumnIndex[tag]
    LibraryGrid[r, DstCol].text = Value
    i = i + 1 '(next couple)
  Next 'i

  'DiffTime = Timer - StartTime
  'PRINT "FillColums() time:" & (DiffTime * 1000) & " msec"
  
'per ogni indice di nomecolonna trovato alla posizione r di Ptable
  'assegna a LibraryGrid[r,quell'indice] il valore che trovi dopo l'uguale
End






Public Function SelectRandom(LibraryGrid As GridView) As Integer
  Dim Random As Integer = 0
  Dim timeout As Integer = LibraryGrid.rows.count 'we don't want to wait forever to play something
  Dim i As Integer = 0
  If LibraryGrid.Rows.count > 0 Then
    'save the first selected row in the array
    If Not RandomArray.Exist(LibraryGrid.row) Then RandomArray.Add(LibraryGrid.row)
    Repeat
      timeout = timeout - 1
      random = Int(Rnd(0, LibraryGrid.Rows.count))
    'roll the dice again if we got the same result,and if the result does not fit into library
    '(it could happen due to the float type of the rnd function)
    Until (Not RandomArray.Exist(random) Or timeout <= 0) And (random <= LibraryGrid.Rows.count - 1) And (random <> LibraryGrid.row)
    'if we got a new successful roll, remember it!
    If timeout > 0 Then RandomArray.Add(random)
  Endif
  ' PRINT "current array:"
  ' FOR i = 0 TO RandomArray.count - 1
  '   PRINT RandomArray[i]
  ' NEXT 'i
  ' PRINT "last random= " & random
  Return random
End

Public Sub SelectNext(LibraryGrid As GridView, Optional random As Boolean = False)
  'will return false if we reached the end, true if the next has been selected.
  Dim NextRandom As Integer = 0
  Try AlreadyPlayedString.Push(librarygrid[librarygrid.row, Columnindex["Full Path"]].text)
  If Random Then
    NextRandom = SelectRandom(LibraryGrid)
    If Not (LibraryGrid.Row = nextrandom) Then Try LibraryGrid.Row = nextrandom
      Else
    If LibraryGrid.row = LibraryGrid.Rows.Count - 1 Then
      LibraryGrid.row = 0
      Global.IsNextSelected = False
        Else
      LibraryGrid.row = LibraryGrid.row + 1
      Global.IsNextSelected = True
    Endif
  Endif
End

Private Function FindRowByPath(LibraryGrid As GridView, path As String) As Integer
  'will search in librarygrid for path and return the row index
  Dim i As Integer
  For i = 0 To LibraryGrid.Rows.count - 1
    If (LibraryGrid[i, Columnindex["Full Path"]].text = path) Then Return i
  Next 'i
  Return -1
End



Public Sub SelectPrev(LibraryGrid As Gridview)
  Dim previouspath As String
  Try previouspath = LibraryGrid[LibraryGrid.row, Columnindex["Full Path"]].text
  'first, try to play the prevoiusly played item:
  Try LibraryGrid.row = FindRowByPath(librarygrid, AlreadyPlayedString.Pop())
  ' if we have none, select the prevoius.
  If Error Then
    'invalidate the history
    AlreadyPlayedString.clear
    'select the previous (ordered) item
    If LibraryGrid.row = 0 Then
      Try LibraryGrid.row = LibraryGrid.Rows.count - 1
        Else
      Try LibraryGrid.row = LibraryGrid.row - 1
    Endif
  Endif
End

Public Sub clear(myplaylist As GridView)
 Ptable.Remove(0, ptable.count)
 Searchtable.Remove(0, SearchTable.Length)
 SyncGrid(myplaylist, searchtable, 0, 0)
 AutoSizeColumns(myplaylist)
End

Public Function HowManySelected(MyPlaylist As GridView) As Integer
  Dim row, count As Integer
  If myplaylist.rows.count > 0 Then
    count = 0
    For row = 0 To myplaylist.Rows.count - 1
      If myplaylist.Rows[row].selected Then
        count = count + 1
      Endif
    Next 'row
  Endif
  Return count
End



Public Function OnlyOneSelected(MyPlaylist As Gridview) As Boolean
  Dim row, count As Integer
  If myplaylist.rows.count > 0 Then
    count = 0
    For row = 0 To myplaylist.Rows.count - 1
      If myplaylist.Rows[row].selected Then
        count = count + 1
        If (count > 1) Then Return False
      Endif
    Next 'row
  Endif
  Return True
End


Public Sub DeleteSelected(MyPlaylist As GridView, Optional DeleteURIes As Boolean = True)
  Dim r, c As Integer
  Dim PrevScrollX, PrevScrollY As Integer
  Dim ColToSelect As Integer = 0
  Dim RowToSelect As Integer = 0
  Dim tmpfullpath As String = ""
  Dim rowheight As Integer
  
  Try ColToSelect = MyPlaylist.Column
  Try RowToSelect = MyPlaylist.row
  Try PrevScrollX = MyPlaylist.scrollx
  Try PrevScrollY = MyPlaylist.scrollY
  'Remove selected items from PTable in reverse order
  r = myplaylist.Rows.Count - 1
  While (r >= 0)
    If myplaylist.Rows[r].Selected Then
      tmpfullpath = Myplaylist[r, Columnindex["Full Path"]].text
      If ((Not ISURI(tmpfullpath)) Or DeleteURIes) Then
        PTable.Remove(PTable.Find(Searchtable[r]))
        Searchtable.Remove(r)
        RowToSelect = r
      Endif
    Endif
    r = r - 1
  Wend
'  rowheight = MyPlaylist.Rows.h
  SyncGrid(MyPlaylist, SearchTable, rowtoselect, ColToSelect)
'  MyPlaylist.Rows.h = rowheight
   ' [GB2:FNTH] MyPlaylist.Rows.h = MyPlaylist.Font.Textheight("^_") + global.rowpadding '<<--
   MyPlaylist.Rows.h = MyPlaylist.Font.TextHeight("^_") + global.rowpadding '<<--
   Try MyPlaylist.scrollx = PrevScrollX
   Try MyPlaylist.scrollY = PrevScrollY
End

Public Sub EraseSelected(MyPlaylist As GridView)
  Dim r, c As Integer
  Dim tmpfullpath As String = ""
  fmain.mouse = mouse.Wait
  'Erase selected items from disk
  r = myplaylist.Rows.Count - 1
  While (r >= 0)
    If myplaylist.Rows[r].Selected Then
      tmpfullpath = Myplaylist[r, Columnindex["Full Path"]].text
      If (Not ISURI(tmpfullpath)) Then
        Try Kill tmpfullpath
      Endif
    Endif
    r = r - 1
  Wend
  fmain.mouse = mouse.Default
End


Public Function ISURI(fullpath As String) As Boolean
  If fullpath Like "*://*" Then
    Return True
      Else
    Return False
  Endif
End


Public Sub UpdateSelected(MyPlaylist As GridView)
  Dim r As Integer = myplaylist.Rows.Count - 1
  Dim fullpaths As New String[]
  Dim fullpath As String
  Dim ColToSelect As Integer = 0
  Dim RowToSelect As Integer = 0
  Dim PrevScrollX As Integer = myplaylist.scrollx
  Dim PrevScrollY As Integer = myplaylist.scrolly
  Dim tmpfullpath As String = ""
  Dim DeleteURIes As Boolean = False
  
  Try ColToSelect = MyPlaylist.Column
  Try RowToSelect = MyPlaylist.row
  myplaylist.Enabled = False
  myplaylist.mouse = mouse.wait
  Wait 0.001
  'find fullpaths in myplaylist
  For r = 0 To myplaylist.rows.count - 1
    If myplaylist.Rows[r].Selected Then
      tmpfullpath = Myplaylist[r, Columnindex["Full Path"]].text
      If (Not ISURI(tmpfullpath)) Then fullpaths.Add(tmpfullpath)
    Endif
  Next 'r
  
  'Remove them from playlist
  DeleteURIes = False
  DeleteSelected(Myplaylist, DeleteURIes)

  'Add them again
  SyncSortedTable()
  For Each fullpath In fullpaths
      If (Not ISURI(fullpath)) Then 
        Try CoverManager.UnMarkUncovered(fullpath)
        AddFile(Myplaylist, fullpath, False, False)
      Endif
  Next
  
  'Restore visualization
  Ascendent = Not Ascendent
    If LastSortedField <> "" Then 'Fixme
      FMain.LibraryGrid_ColumnClick(ColumnIndex[LastSortedField])
        Else
      FMain.LibraryGrid_ColumnClick(0)
      Ascendent = Not Ascendent
    Endif
  SyncGrid(MyPlaylist, SearchTable, RowToSelect, ColToSelect)
  Myplaylist.scrollx = PrevScrollX + 1
  Myplaylist.scrollx = PrevScrollX - 1
  Myplaylist.scrolly = PrevScrolly + 1
  Myplaylist.scrolly = PrevScrolly - 1
  
  myplaylist.enabled = True
  myplaylist.mouse = mouse.Default

End


Public Sub Alternatecolor(myplaylist As GridView)
 Dim r, c As Integer
     For r = 0 To myplaylist.Rows.count - 1
       If Not Alternate Then
         For c = 0 To MyPlaylist.Columns.count - 1
           MyPlaylist[r, c].text = MyPlaylist[r, c].text
           MyPlaylist[r, c].background = Global.Alternatecolor
         Next 'c
           Else
         For c = 0 To MyPlaylist.Columns.count - 1
           MyPlaylist[r, c].text = MyPlaylist[r, c].text
           ' [GB2:BCOL] MyPlaylist[r, c].background = MyPlaylist.background
           MyPlaylist[r, c].background = MyPlaylist.Background
         Next 'c
       Endif
       Alternate = Not (alternate)
   Next 'r
End




Public Sub AddDir(LibraryGrid As Gridview, DirToAdd As String, ExcludeList As ListBox)
 Dim filename As String
 Dim quickmode As Boolean = True
 Dim MyEXIST As Boolean = True
 Dim MatchExcluded As Boolean = False
 Dim i, e As Integer
 'SyncSortedTable() '<-could be necessary for playlist.isdupe() 
 'FUNCTION , but very slow, so I TRY TO remove AND see what happens...
 'WAIT 0.001 '< - slows down LIKE hell on 64 bit!

 If (ExcludeList.count) > 0 Then
  For i = 0 To ExcludeList.count - 1
    If (DirToAdd = ExcludeList[i].text) Or (DirToAdd & "/" = ExcludeList[i].text) Then
      MatchExcluded = True
      Debug "Excluded item: " & DirToAdd
      Break
    Endif
  Next 'i
 Endif
 

 
 
 If Exist(dirtoadd) And (Not MatchExcluded) Then
   For Each filename In Dir(DirToAdd).Sort()
    If Right(DirToAdd) <> "/" Then DirToadd = DirToAdd & "/"
    MyExist = True
    If Stat(DirToAdd & filename).type = gb.Link Then
      MyExist = Exist(Stat(DirToAdd & filename).link)
    Endif
    If MyExist Then
      If Stat(DirToAdd & filename, True).Type = gb.file Then
          AddFile(LibraryGrid, DirToAdd & filename, Not (quickmode), False)
          If Global.LSyncing Then fmain.WaitPanel.text = Global.LSyncingMessage & "<br>" & dirtoadd
        Else If Stat(DirToAdd & filename, True).Type = gb.Directory Then
          Try AddDir(LibraryGrid, DirToAdd & filename, ExcludeList)
          'IF Global.LSyncing THEN fmain.WaitPanel.text = Global.LSyncingMessage & "<br>" & filename
      Endif
    Endif
   ' ENDIF
   Next
 Endif
 'Alternatecolor(LibraryGrid)
End



Public Sub SyncSortedTable()
'Will fill SortTable with Full paths from ptable
'and sort it to allow fast searches for duplicates through function IsDupe()
'** SyncSortTable must be called from outside after ptable updates. **
  'DIM starttime AS Date = Now
  'DIM endtime AS Date
   
  
  Dim i As Integer
  Dim Startpos, MidPos, EndPos As Integer
  Dim MyValue As String
  Dim Field As String = "Full Path"
  SortTable.clear
  'PRINT "Debug: playlistclass syncsorttable() start at: " & Time
  For i = 0 To ptable.count - 1
    ' StartPos = InStr(Ptable[i], TableSeparator & Field)
    ' MidPos = InStr(Ptable[i], TableSeparator, StartPos + 1)
    ' EndPos = InStr(Ptable[i], TableSeparator, Midpos + 1)
    ' MyValue = Mid(Ptable[i], midpos + 1, Endpos - (midpos + 1))
    SortTable.Add(GetValue(Ptable[i], Field))
  Next 'i
  ' [GB2:TEXT] SortTable = SortTable.Sort(gb.text)
  SortTable = SortTable.Sort(gb.IgnoreCase)
  'PRINT "Debug: playlistclass syncsorttable() end at: " & Time
  
  'endtime = Now
  'Global.syncsorttabletime = Global.syncsorttabletime + CFloat(endtime) - CFloat(starttime)
  
End


Private Function BinarySearch(item As String) As Integer
  Dim first, Tlast, middle As Integer
  Dim OutValue As Integer = -1
  Dim MiddleItem As String
  first = 0
  Tlast = SortTable.count - 1
  ' IF item = "/mnt/disco2/vcast/download/Star_trek_migliori.mp4" THEN 
  '   PRINT "break"
  ' ENDIF
  Repeat
    middle = (first + tlast) / 2
    MiddleItem = SortTable[middle]
    If Trim(MiddleItem) = Trim(item) Then
      Return middle
    
    'gb.text is a case unsensitive comparision, 
    'we've to manage the sensitive comparision
    'via a gb.binary search
    Else If Trim(Lower(middleitem)) = Trim(Lower(item)) Then
      If Comp(MiddleItem, item, gb.binary) < 0 Then
        first = middle + 1
          Else
        tlast = middle - 1
      Endif
      
    ' [GB2:TEXT] Else If Comp(MiddleItem, item, gb.text) < 0 Then  'ITEM > middle
    Else If Comp(MiddleItem, item, gb.IgnoreCase) < 0 Then  'ITEM > middle
        first = middle + 1
    ' [GB2:TEXT] Else If Comp(MiddleItem, item, gb.text) > 0 Then  'ITEM < middle
    Else If Comp(MiddleItem, item, gb.IgnoreCase) > 0 Then  'ITEM < middle
        tlast = middle - 1
    Endif
  Until first > Tlast
End




Public Function IsDupe(item As String) As Boolean
'binary search in sorttable for item
  If SortTable.count > 0 Then
    If BinarySearch(item) > 0 Then
      Return True
        Else
      'PRINT "Debug: PlaylistClass: IsDupe() Not Dupe= " & item   
      Return False
    Endif
  Endif
End


Public Function RemoveNonExisting() As String[]
  'will scan ptable (field FullPath)
  'and remove non existing files from it
  Dim i, numremoved, startpos, midpos, endpos As Integer
  Dim FullPathName As String
  Dim ReturnString As New String[]
  i = ptable.count - 1
  While i >= 0
    Startpos = InStr(Ptable[i], TableSeparator & "Full Path")
    MidPos = InStr(Ptable[i], TableSeparator, StartPos + 1)
    EndPos = InStr(Ptable[i], TableSeparator, Midpos + 1)
    FullPathName = Mid(Ptable[i], MidPos + 1, endpos - midpos - 1)
    If Not (Exist(FullPathName)) Then
      ptable.Remove(i)
      ReturnString.Add(FullPathName)
      'PRINT "Debug: PlaylistClass: RemoveNonExisting(): Removed: " & FullPathName
    Endif
    i = i - 1
  Wend
  Return ReturnString
End


Public Function RemoveNonExistingOld28062010() As String[]
  'will scan ptable (field FullPath)
  'and remove non existing files from it
  Dim i, numremoved, startpos, midpos, endpos As Integer
  Dim FullPathName As String
  Dim ReturnString As New String[]
  i = ptable.count - 1
  While i > 0
    i = i - 1
    Startpos = InStr(Ptable[i], TableSeparator & "Full Path")
    MidPos = InStr(Ptable[i], TableSeparator, StartPos + 1)
    EndPos = InStr(Ptable[i], TableSeparator, Midpos + 1)
    FullPathName = Mid(Ptable[i], MidPos + 1, endpos - midpos - 1)
    If Not (Exist(FullPathName)) Then
      ptable.Remove(i)
      ReturnString.Add(FullPathName)
      'PRINT "Debug: PlaylistClass: RemoveNonExisting(): Removed: " & FullPathName
    Endif
  Wend
  Return ReturnString
End

Public Sub DeleteFromPath(fullpath As String)
  'will scan ptable (field FullPath)
  'and remove the item associated with fullpath
  Dim i, startpos, midpos, endpos As Integer
  Dim FullPathName As String
  i = ptable.count - 1
  While i >= 0
    Startpos = InStr(Ptable[i], TableSeparator & "Full Path")
    MidPos = InStr(Ptable[i], TableSeparator, StartPos + 1)
    EndPos = InStr(Ptable[i], TableSeparator, Midpos + 1)
    FullPathName = Mid(Ptable[i], MidPos + 1, endpos - midpos - 1)
    If fullpathname = fullpath Then
      ptable.Remove(i)
      Debug "PlaylistClass: Deletefrompath(): Deleted: " & FullPathName
    Endif
    i = i - 1
  Wend
End
  
Public Sub FormatTime(seconds As String) As String

  Dim iseconds, hh, mm, ss, restosec As Integer
  Dim Shh, Smm, Sss As String

  Try iseconds = Val(seconds)
  If Error Then iseconds = 0
  hh = iseconds Div 3600
  restosec = (iseconds - (hh * 3600))
  mm = restosec Div 60
  ss = (restosec - (mm * 60))
  Sss = ss
  If Len(Sss) = 1 Then Sss = "0" & Sss
  Smm = mm
  If Len(Smm) = 1 Then Smm = "0" & Smm
  Shh = hh
  If Len(Shh) = 1 Then Shh = "0" & Shh
  Return Shh & ":" & Smm & ":" & Sss

End
  
Private Sub makenewrow(librarygrid As Gridview, forcename As String, filetoadd As String, length As String, type As String, acodec As String, abitrate As String, arate As String, channels As String, vcodec As String, vbitrate As String, fps As String, w As String, h As String, artist As String, album As String, myyear As String, track As String, title As String, genre As String, comment As String)  
  Dim nr As String 'newrow
  Dim ts As String = TableSeparator
  Dim filesize As Integer = 0

  If track = 0 Then track = ""
  If myYear = 0 Then myYear = ""
  
  Try filesize = Stat(filetoadd).size Div 1024
  If forcename <> "" Then
    nr = nr & ts & "Filename" & ts & forcename
      Else
    nr = nr & ts & "Filename" & ts & file.Name(filetoadd)
  Endif

  nr = nr & ts & "Length" & ts & FormatTime(length)
  nr = nr & ts & "Artist" & ts & artist
  nr = nr & ts & "Album" & ts & album
  nr = nr & ts & "Year" & ts & myyear
  nr = nr & ts & "Track" & ts & track
  nr = nr & ts & "Title" & ts & title
  nr = nr & ts & "Genre" & ts & genre
  nr = nr & ts & "Comment" & ts & comment
  nr = nr & ts & "Type" & ts & type
  nr = nr & ts & "Audio Codec" & ts & acodec
  nr = nr & ts & "Audio Bitrate" & ts & abitrate
  nr = nr & ts & "Audio Rate" & ts & arate
  nr = nr & ts & "Channels" & ts & channels
  nr = nr & ts & "Video Codec" & ts & vcodec
  nr = nr & ts & "Video Bitrate" & ts & vbitrate
  nr = nr & ts & "Fps" & ts & fps
  nr = nr & ts & "Width" & ts & w
  nr = nr & ts & "Height" & ts & h
  nr = nr & ts & "Full Path" & ts & filetoadd
  nr = nr & ts & "File Size" & ts & filesize
  nr = nr & ts & "Added on" & ts & Now & ts
  
  ptable.Add(nr)
  Searchtable.Add(nr)
  LibraryGrid.Rows.count = LibraryGrid.Rows.count + 1
End

  
  
Public Function AddFile(LibraryGrid As GridView, FileToAdd As String, Optional quick As Boolean = True, Optional Urimode As Boolean = False, Optional Forcename As String = "") As Boolean
  Dim LastRow As Integer
  Dim i As Integer
  Dim filesize As Integer = 0
  Dim quickmode As Boolean = quick And (GeneralOptions.SlowTagsCHK.value Or Global.IsNonTaggableMedia(FileToAdd))
  Dim tl As New Taglib
  Dim fileutf8 As String
  Dim length, type, acodec, abitrate, arate, channels, vcodec, vbitrate, fps, w, h, fullpath As String
  Dim artist, album, myyear, track, title, genre, comment As String
  
  FilesProcessed = FilesProcessed + 1
  UpdateProgress(FMain.MyLibraryProgressBar)
  Wait 0.0001

  If Trim(filetoadd) = "" Then Return True

  If quickmode Then
    makenewrow(librarygrid, forcename, filetoadd, length, type, acodec, abitrate, arate, channels, vcodec, vbitrate, fps, w, h, artist, album, myyear, track, title, genre, comment)
    Return True
  Endif
  
  Try filesize = Stat(FileToAdd).Size
  If filesize = 0 Then Return True
  If Not (Exist(filetoadd)) Then Return True
  If Not (global.IsMediaFile(filetoadd)) Then Return True  
  If IsDupe(filetoadd) Then Return True

  Try fileUtf8 = DConv(filetoadd) 'from system charset to utf8
  If Error Then fileutf8 = filetoadd
  fileutf8 = filetoadd
  If tl.IsSupported(fileUtf8) And tl.Init(fileUtf8) Then 'use fast taglib when possible
    length = tl.Length
    type = "audio"
    acodec = file.Ext(fileUtf8)
    abitrate = tl.Bitrate
    arate = tl.Samplerate
    channels = tl.Channels
    vcodec = ""
    vbitrate = ""
    fps = ""
    w = ""
    h = ""
    artist = (tl.Artist)
    album = (tl.Album)
    myyear = tl.MyYear
    track = tl.Track
    title = (tl.Title)
    genre = (tl.Genre)
    comment = (tl.Comment)
    tl.tlFree()
    
      Else 'but fallback to mplayertag if needed
    Debug "TagLib doesnt support " & FileToAdd & ",fallback to mplayer routines..."
    If (Not quickmode) Then CheckPlayerAlive()
    MplayerTag.quick = quickmode
    If Not quick Then MplayerTag.do_idleplay(FileToAdd)
    length = mplayertag.Media_Length
    type = mplayertag.Media_Type
    acodec = mplayertag.Media_AudioCodec
    abitrate = mplayertag.Media_AudioBitrate
    arate = mplayertag.Media_AudioRate
    channels = mplayertag.Media_Channels
    vcodec = mplayertag.Media_VideoCodec
    vbitrate = mplayertag.Media_VideoBitrate
    fps = mplayertag.Media_VideoFps
    w = mplayertag.Media_Width
    h = mplayertag.Media_Height
    artist = mplayertag.Media_Artist
    album = mplayertag.Media_Album
    myyear = mplayertag.Media_Year
    track = mplayertag.Media_TrackNo
    title = mplayertag.Media_Title
    genre = mplayertag.Media_Genre
    comment = OneOf(MplayerTag.Media_Comment, MplayerTag.Media_Comments)
  Endif


  makenewrow(librarygrid, forcename, filetoadd, length, type, acodec, abitrate, arate, channels, vcodec, vbitrate, fps, w, h, artist, album, myyear, track, title, genre, comment)
  Return True
End




' Public Function oldAddFile(LibraryGrid As GridView, FileToAdd As String, Optional quick As Boolean = True, Optional Urimode As Boolean = False, Optional Forcename As String = "") As Boolean
'   Dim LastRow As Integer
'   Dim audiotag As New AudiotagClass
'   Dim i As Integer
'   Dim NewRow As String
'   Dim filesize As Integer = 0
'   Dim quickmode As Boolean = quick And (GeneralOptions.SlowTagsCHK.value Or Global.IsNonTaggableMedia(FileToAdd))
' 
'   FilesProcessed = FilesProcessed + 1
'   UpdateProgress(FMain.MyLibraryProgressBar)
' 
'   If (Exist(filetoadd) Or UriMode) And Trim(filetoadd) <> "" Then
'     If (Global.IsMediaFile(FileToAdd) Or Urimode) Then
'       Try filesize = Stat(FileToAdd).Size
'       Debug IsDupe(fileToAdd)
'       Debug (filesize <> 0)
'       Debug urimode
'       
'       If ((Not (IsDupe(FileToAdd))) And ((filesize <> 0) Or Urimode)) Then
'         If (Not quickmode) Then CheckPlayerAlive()
'         
'         MplayerTag.quick = quickmode
'         If Not quick Then MplayerTag.do_idleplay(FileToAdd)
' 
'         
'         
'         If (Trim(FileToAdd) <> "") Then
'           If Forcename <> "" Then
'             NewRow = Newrow & TableSeparator & "Filename" & TableSeparator & Forcename
'               Else
'             NewRow = Newrow & TableSeparator & "Filename" & TableSeparator & File.Name(FileToAdd)
'           Endif
'           NewRow = Newrow & TableSeparator & "Length" & TableSeparator & MplayerTag.FormatTime(MplayerTag.Media_Length)
'           NewRow = Newrow & TableSeparator & "Type" & TableSeparator & MplayerTag.Media_Type
'           NewRow = Newrow & TableSeparator & "Audio Codec" & TableSeparator & MplayerTag.Media_AudioCodec
'           NewRow = Newrow & TableSeparator & "Audio Bitrate" & TableSeparator & MplayerTag.Media_AudioBitrate
'           NewRow = Newrow & TableSeparator & "Audio Rate" & TableSeparator & MplayerTag.Media_AudioRate
'           NewRow = Newrow & TableSeparator & "Channels" & TableSeparator & MplayerTag.Media_Channels
'           NewRow = Newrow & TableSeparator & "Video Codec" & TableSeparator & MplayerTag.Media_VideoCodec
'           NewRow = Newrow & TableSeparator & "Video Bitrate" & TableSeparator & MplayerTag.Media_VideoBitrate
'           NewRow = Newrow & TableSeparator & "Fps" & TableSeparator & MplayerTag.Media_VideoFps
'           NewRow = Newrow & TableSeparator & "Width" & TableSeparator & MplayerTag.Media_Width
'           NewRow = Newrow & TableSeparator & "Height" & TableSeparator & MplayerTag.Media_Height
'           NewRow = Newrow & TableSeparator & "Full Path" & TableSeparator & FileToAdd
'           Try NewRow = Newrow & TableSeparator & "File Size" & TableSeparator & filesize
'           NewRow = Newrow & TableSeparator & "Added on" & TableSeparator & Now
'           
'           If (((Upper(filetoadd) Like "*.FLAC") Or (Upper(filetoadd) Like "*.OGG")) And (Not quickmode)) Then 'use audiotag for flac files
'             Audiotag.GetTags(FileToAdd)
'             NewRow = Newrow & TableSeparator & "Artist" & TableSeparator & audiotag.Artist
'             NewRow = Newrow & TableSeparator & "Album" & TableSeparator & audiotag.album
'             NewRow = Newrow & TableSeparator & "Year" & TableSeparator & OneOf(audiotag.MyDate, audiotag.MyYear)
'             NewRow = Newrow & TableSeparator & "Track" & TableSeparator & OneOf(audiotag.Tracknum, audiotag.Tracknumber)
'             NewRow = Newrow & TableSeparator & "Title" & TableSeparator & audiotag.Title
'             NewRow = Newrow & TableSeparator & "Genre" & TableSeparator & audiotag.Genre
'             NewRow = Newrow & TableSeparator & "Comment" & TableSeparator & OneOf(audiotag.comment, audiotag.Comments)
'               Else
'             NewRow = Newrow & TableSeparator & "Album" & TableSeparator & MplayerTag.Media_Album
'             NewRow = Newrow & TableSeparator & "Artist" & TableSeparator & OneOf(MplayerTag.Media_Artist, MplayerTag.Media_Author)
'             NewRow = Newrow & TableSeparator & "Title" & TableSeparator & OneOf(MplayerTag.Media_Title, MplayerTag.Media_Name)
'             NewRow = Newrow & TableSeparator & "Year" & TableSeparator & OneOf(MplayerTag.Media_Year, MplayerTag.Media_CreationDate)
'             NewRow = Newrow & TableSeparator & "Genre" & TableSeparator & MplayerTag.media_genre
'             NewRow = Newrow & TableSeparator & "Track" & TableSeparator & MplayerTag.Media_TrackNo
'             NewRow = Newrow & TableSeparator & "Comment" & TableSeparator & OneOf(MplayerTag.Media_Comment, MplayerTag.Media_Comments) & TableSeparator
'           Endif
'           
'           'PRINT "Debug: PlaylistClass: AddFile(): NewRow= " & NewRow  
'           PTable.Add(NewRow)
'           SearchTable.Add(NewRow)
'           LibraryGrid.Rows.count = LibraryGrid.Rows.count + 1
'           'FillColumns(LibraryGrid, SearchTable.count - 1)
'         Endif
'       Endif
'     Endif
'   Endif
'   Return True
' End


' Public Function tryAddFile(LibraryGrid As GridView, FileToAdd As String, Optional quick As Boolean = True, Optional Urimode As Boolean = False, Optional Forcename As String = "") As Boolean
'   Dim LastRow As Integer
'   Dim audiotag As New AudiotagClass
'   Dim i As Integer
'   Dim NewRow As String
'   Dim filesize As Integer = 0
'   Dim quickmode As Boolean = quick And (GeneralOptions.SlowTagsCHK.value Or Global.IsNonTaggableMedia(FileToAdd))
' 
'   FilesProcessed = FilesProcessed + 1
'   UpdateProgress(FMain.MyLibraryProgressBar)
' 
'   If (Exist(filetoadd) Or UriMode) And Trim(filetoadd) <> "" Then
'     If (Global.IsMediaFile(FileToAdd) Or Urimode) Then
'       Try filesize = Stat(FileToAdd).Size
'       Debug IsDupe(fileToAdd)
'       Debug (filesize <> 0)
'       Debug urimode
'       
'       If (Not (IsDupe(FileToAdd))) Then
'         Debug (Not (IsDupe(FileToAdd)))
'         Debug (IsDupe(FileToAdd))
'         If ((filesize <> 0) Or Urimode) Then
'           If (Not quickmode) Then CheckPlayerAlive()
'           
'           MplayerTag.quick = quickmode
'           If Not quick Then MplayerTag.do_idleplay(FileToAdd)
'   
'   
'           If (Trim(FileToAdd) <> "") Then
'             If Forcename <> "" Then
'               NewRow = Newrow & TableSeparator & "Filename" & TableSeparator & Forcename
'                 Else
'               NewRow = Newrow & TableSeparator & "Filename" & TableSeparator & File.Name(FileToAdd)
'             Endif
'             NewRow = Newrow & TableSeparator & "Length" & TableSeparator & MplayerTag.FormatTime(MplayerTag.Media_Length)
'             NewRow = Newrow & TableSeparator & "Type" & TableSeparator & MplayerTag.Media_Type
'             NewRow = Newrow & TableSeparator & "Audio Codec" & TableSeparator & MplayerTag.Media_AudioCodec
'             NewRow = Newrow & TableSeparator & "Audio Bitrate" & TableSeparator & MplayerTag.Media_AudioBitrate
'             NewRow = Newrow & TableSeparator & "Audio Rate" & TableSeparator & MplayerTag.Media_AudioRate
'             NewRow = Newrow & TableSeparator & "Channels" & TableSeparator & MplayerTag.Media_Channels
'             NewRow = Newrow & TableSeparator & "Video Codec" & TableSeparator & MplayerTag.Media_VideoCodec
'             NewRow = Newrow & TableSeparator & "Video Bitrate" & TableSeparator & MplayerTag.Media_VideoBitrate
'             NewRow = Newrow & TableSeparator & "Fps" & TableSeparator & MplayerTag.Media_VideoFps
'             NewRow = Newrow & TableSeparator & "Width" & TableSeparator & MplayerTag.Media_Width
'             NewRow = Newrow & TableSeparator & "Height" & TableSeparator & MplayerTag.Media_Height
'             NewRow = Newrow & TableSeparator & "Full Path" & TableSeparator & FileToAdd
'             Try NewRow = Newrow & TableSeparator & "File Size" & TableSeparator & filesize
'             NewRow = Newrow & TableSeparator & "Added on" & TableSeparator & Now
'             
'             If (((Upper(filetoadd) Like "*.FLAC") Or (Upper(filetoadd) Like "*.OGG")) And (Not quickmode)) Then 'use audiotag for flac files
'               Audiotag.GetTags(FileToAdd)
'               NewRow = Newrow & TableSeparator & "Artist" & TableSeparator & audiotag.Artist
'               NewRow = Newrow & TableSeparator & "Album" & TableSeparator & audiotag.album
'               NewRow = Newrow & TableSeparator & "Year" & TableSeparator & OneOf(audiotag.MyDate, audiotag.MyYear)
'               NewRow = Newrow & TableSeparator & "Track" & TableSeparator & OneOf(audiotag.Tracknum, audiotag.Tracknumber)
'               NewRow = Newrow & TableSeparator & "Title" & TableSeparator & audiotag.Title
'               NewRow = Newrow & TableSeparator & "Genre" & TableSeparator & audiotag.Genre
'               NewRow = Newrow & TableSeparator & "Comment" & TableSeparator & OneOf(audiotag.comment, audiotag.Comments)
'                 Else
'               NewRow = Newrow & TableSeparator & "Album" & TableSeparator & MplayerTag.Media_Album
'               NewRow = Newrow & TableSeparator & "Artist" & TableSeparator & OneOf(MplayerTag.Media_Artist, MplayerTag.Media_Author)
'               NewRow = Newrow & TableSeparator & "Title" & TableSeparator & OneOf(MplayerTag.Media_Title, MplayerTag.Media_Name)
'               NewRow = Newrow & TableSeparator & "Year" & TableSeparator & OneOf(MplayerTag.Media_Year, MplayerTag.Media_CreationDate)
'               NewRow = Newrow & TableSeparator & "Genre" & TableSeparator & MplayerTag.media_genre
'               NewRow = Newrow & TableSeparator & "Track" & TableSeparator & MplayerTag.Media_TrackNo
'               NewRow = Newrow & TableSeparator & "Comment" & TableSeparator & OneOf(MplayerTag.Media_Comment, MplayerTag.Media_Comments) & TableSeparator
'             Endif
'             
'             'PRINT "Debug: PlaylistClass: AddFile(): NewRow= " & NewRow  
'             PTable.Add(NewRow)
'             SearchTable.Add(NewRow)
'             LibraryGrid.Rows.count = LibraryGrid.Rows.count + 1
'             'FillColumns(LibraryGrid, SearchTable.count - 1)
'           Endif
'         Endif
'       Endif
'     Endif
'   Endif
'   Return True
' End


Private Sub UpdateProgress(TheProgressbar As ProgressBar)
  If FilesToProcess = 0 Then FilesToProcess = 1
  TheProgressBar.Value = Filesprocessed / FilesToProcess
  
End

Public Sub ClearAround(LibraryGrid As Gridview, FirstVisibleRow As Integer, LastVisibleRow As Integer)
  ' DIM r AS Integer
  ' DIM c AS Integer
  ' DIM howmanyrows AS Integer = ((LastVisibleRow - FirstVisibleRow) DIV 8) - 4
  '   
  ' IF howmanyrows < 0 THEN howmanyrows = 1  
  ' IF FirstVisibleRow - howmanyrows > 0 THEN  
  '   LibraryGrid.Rows.Remove(FirstVisibleRow - howmanyrows, howmanyrows)
  '   LibraryGrid.Rows.insert(FirstVisibleRow - howmanyrows, howmanyrows)
  ' ENDIF
  ' 
  ' IF LastVisibleRow + howmanyrows < LibraryGrid.rows.count THEN
  '   LibraryGrid.Rows.Remove(LastVisibleRow, howmanyrows)
  '   LibraryGrid.Rows.insert(lastVisibleRow, howmanyrows)
  ' ENDIF
End







Public Sub FillRows(LibraryGrid As Gridview, StartRow As Integer, EndRow As Integer, AlternateColors As Boolean)
'will draw rows LibraryGrid in range StartRow...EndRow with values from SearchTable
  Dim r As Integer
  'PRINT "Debug: PlaylistClass: FillRows()"
  For r = StartRow To EndRow
    If LibraryGrid[r, Columnindex["Filename"]].text = "" Then
      FillColumns(LibraryGrid, r)
      If AlternateColors Then AlternatecolorRange(LibraryGrid, r, r)
        Else
     'PRINT "Debug: PlaylistClass: FillRows(): Row already filled with" & LibraryGrid[r, ColumnIndex["Filename"]].text
    Endif
  Next 'r
  'DiffTime = Timer - StartTime
  'PRINT "Fillrows() time:" & (DiffTime * 1000) & " msec"
End

Public Sub DoSort(Field As String)
  Dim i As Integer
  Dim Startpos, MidPos, EndPos As Integer
  Dim MyValue As String
  For i = 0 To ptable.count - 1
    StartPos = InStr(Ptable[i], TableSeparator & Field)
    MidPos = InStr(Ptable[i], TableSeparator, StartPos + 1)
    EndPos = InStr(Ptable[i], TableSeparator, Midpos + 1)
    MyValue = Mid(Ptable[i], Startpos, Endpos - startpos)
    Replace(Ptable[i], MyValue, "")
    Ptable[i] = MyValue & Ptable[i]
  Next 'i

  If Ascendent Then
    ' [GB2:TEXT] ptable = ptable.Sort(gb.Ascent + gb.text)
    ptable = ptable.Sort(gb.Ascent + gb.IgnoreCase)
      Else
    ' [GB2:TEXT] Ptable = ptable.Sort(gb.Descent + gb.text)
    Ptable = ptable.Sort(gb.Descent + gb.IgnoreCase)
  Endif
  Ascendent = Not Ascendent
  '"public" the last sorted field
  LastSortedField = field
End



Public Sub AlternatecolorRange(myplaylist As GridView, StartRow As Integer, EndRow As Integer, Optional SKIPFIRST As Boolean = False)
  Dim r, c As Integer
  Dim Alternate As Boolean
  Try Alternate = Not (MyPlaylist[StartRow - 1, 0].background = Global.Alternatecolor)
  'maybe a gambas bug requires the text to be rewritten before changing the color
  'but if we have a picture in the control, it would be deleted, so skipfirst
  'will not recolor anything, leaving the picture intact (used in the retag routine)
  For r = StartRow To EndRow
    If Alternate Then
      For c = 0 To MyPlaylist.Columns.count - 1
        If Not (SKIPFIRST And c = 0) Then
          MyPlaylist[r, c].text = MyPlaylist[r, c].text
          MyPlaylist[r, c].background = Global.Alternatecolor
        Endif
      Next 'c
        Else
      For c = 0 To MyPlaylist.Columns.count - 1
        If Not (SKIPFIRST And c = 0) Then
          MyPlaylist[r, c].text = MyPlaylist[r, c].text
          ' [GB2:BCOL] MyPlaylist[r, c].background = MyPlaylist.background
          MyPlaylist[r, c].background = MyPlaylist.Background
        Endif
      Next 'c
    Endif
    Alternate = Not (alternate)
  Next 'r
End

Public Sub LegacyAutoSizeColumns(MyGrid As GridView) 'will autosize Every Row.
    Dim TheColumn As Integer
    If fmain.closing Then Return
     For TheColumn = 0 To MyGrid.Columns.count - 1
       Wait 0.001
       MyGrid.Columns[TheColumn].W = -1
   Next 'thecolumn
End




Public Sub AutoSizeColumns(MyGrid As GridView) 'Just autosize visible rows (way faster,but incomplete)
    Dim TheColumn As Integer
    Dim R, FirstR, LastR As Integer
    Dim C, FirstC, LastC As Integer
    Dim TextW As Integer
    Dim Text As String
    
    If fmain.closing Then Return
    If MyGrid.Rows.count <= 0 Then Return
    FirstR = MyGrid.RowAt(MyGrid.y)
    LastR = MyGrid.RowAt(MyGrid.h)
    If LastR = -1 Then LastR = Mygrid.rows.count - 1
    If firstR = -1 Then firstR = 0
    
    FirstC = 0
    LastC = MyGrid.Columns.Count - 1

    'reset width
    For c = FirstC To LastC
      MyGrid.Columns[C].W = 80
    Next 'c

    Debug "Doing from " & FirstR & " - to " & LastR
    For R = FirstR To LastR
      For C = FirstC To LastC
        Text = MyGrid[R, C].text
        ' [GB2:FNTW] TextW = MyGrid.Font.TextWidth(text & "_____")
        TextW = MyGrid.Font.TextWidth(text & "_____")
        If TextW > MyGrid.Columns[C].W Then
          MyGrid.Columns[C].W = TextW
        Endif
      Next 'C
    Next 'R
End


Public Sub SyncGrid(LibraryGrid As Gridview, SearchTable As String[], RowToSelect As Integer, ColToSelect As Integer)
Dim r, c As Integer
'will sync LibraryGrid to SearchTable.
  'It is not necessary to blank the entire Playlist,
  '(We'll blank only the "FileName" Column because FillRows checks just it)
  Try c = Columnindex["Filename"]
  If Error Then Return
  LibraryGrid.Rows.count = 0
  LibraryGrid.rows.count = SearchTable.Count
  LibraryGrid.moveto(RowToSelect, ColToSelect)
  'appropriate calls to fillrows will 'paint' only the necessary rows for speed reason
End


Public Sub Search(LibraryGrid As GridView, SearchExp As String)
'Search in ptable and add to Searchtable
  Dim SearchTerms As String[] = Split(SearchExp, "|")
  Dim SearchTerm, MyValue As String
  Dim UserField As Boolean = False 'matches the search field the user want find
  Dim TheCheckBox As Object
  Dim r As Integer
  Dim Match As Boolean
  Searchtable.Resize(0)
  If SearchExp <> "" Then
    For r = 0 To PTable.count - 1
      For Each Searchterm In SearchTerms
        SearchTerm = Upper(Replace(SearchTerm, "*", ""))
        If (Upper(ptable[r]) Like "*" & Searchterm & "*") Or (searchterm = Null) Then
          UserField = False
          'restrict search to user field search fields
          For Each TheCheckBox In Searchfields.Controls
            MyValue = Upper(Trim(GetValue(ptable[r], TheCheckBox.tag)))
            If TheCheckBox Is CheckBox Then
              If TheCheckBox.value = True Then
                If (myvalue <> "") And (MyValue Like ("*" & Searchterm & "*")) Then
                  'PRINT "Debug: PlaylistClass: Search(): " & myvalue & " is like " & "*" & Searchterm & "* "
                  'PRINT "Debug: PlaylistClass: Search(): " & Searchterm & " found in " & TheCheckBox.tag
                  UserField = True
                    Else
                  'PRINT "Debug: PlaylistClass: Search(): " & myvalue & " is NOT like " & "*" & Searchterm & " *" 
                Endif
              Endif
            Endif
            If UserField Then Break
          Next
          If userfield Then SearchTable.Add(ptable[r])
          Break
        Endif
      Next
    Next  'r
      Else
    For r = 0 To PTable.count - 1
      SearchTable.Add(ptable[r])
    Next 'r
  Endif
  SyncGrid(LibraryGrid, SearchTable, 0, 0)
End

Public Sub UpdateTableAndGridTags(LibraryGrid As Gridview, FullPath As String, Album As String, Artist As String, Title As String, MyYear As String, Genre As String, TrackNo As String, Comment As String)
  'write relevant tags on SearchTable and blindly reflect changes on the grid
  Dim myrow As String
  Dim SearchRowIndex, PTableRowIndex As Integer
  Dim backcolor, row As Integer
  Dim c As Integer
  Dim ts As String = TableSeparator
  'find the searchtable item in ptable and assign his index to myrowindex
  SearchRowIndex = FindRowByPath(Librarygrid, FullPath)
  If SearchRowIndex < 0 Then Return 'item not found!
  PTableRowIndex = Ptable.Find(Searchtable[SearchRowIndex])
  If PTableRowIndex < 0 Then
    'PRINT "Debug: PlaylistClass: UpdateTableAndGridTags(): ITEM NOT FOUND"
    Return 'item not found!
  Endif
  MyRow = Ptable[PTableRowIndex]
  Backcolor = LibraryGrid[row, 0].background
  'Do the substitutions  and update the grid
   If Album <> ts Then 'ts means that we don't have to update anything
      MyRow = Replace(MyRow, ts & "Album" & ts & GetValue(MyRow, "Album") & Ts, ts & "Album" & ts & Album & Ts)
      LibraryGrid[SearchRowIndex, Columnindex["Album"]].text = Album
      'LibraryGrid[SearchRowIndex, Columnindex["Album"]].background = backcolor
   Endif
   If Artist <> ts Then
      MyRow = Replace(MyRow, ts & "Artist" & ts & GetValue(MyRow, "Artist") & Ts, ts & "Artist" & ts & Artist & Ts)
      LibraryGrid[SearchRowIndex, Columnindex["Artist"]].text = Artist
      'LibraryGrid[SearchRowIndex, Columnindex["Artist"]].background = backcolor
   Endif
   If Title <> ts Then
      MyRow = Replace(MyRow, ts & "Title" & ts & GetValue(MyRow, "Title") & Ts, ts & "Title" & ts & Title & Ts)
      LibraryGrid[SearchRowIndex, Columnindex["Title"]].text = Title
      'LibraryGrid[SearchRowIndex, Columnindex["Title"]].background = backcolor
   Endif
   If MyYear <> ts Then
      MyRow = Replace(MyRow, ts & "Year" & ts & GetValue(MyRow, "Year") & ts, ts & "Year" & ts & MyYear & ts)
      LibraryGrid[SearchRowIndex, Columnindex["Year"]].text = MyYear
      'LibraryGrid[SearchRowIndex, Columnindex["Year"]].background = backcolor
   Endif
   If Genre <> ts Then
      MyRow = Replace(MyRow, ts & "Genre" & ts & GetValue(MyRow, "Genre") & ts, ts & "Genre" & ts & Genre & ts)
      LibraryGrid[SearchRowIndex, Columnindex["Genre"]].text = Genre
      'LibraryGrid[SearchRowIndex, Columnindex["Genre"]].background = backcolor
   Endif
   If TrackNo <> ts Then
      MyRow = Replace(MyRow, ts & "Track" & ts & GetValue(MyRow, "Track") & ts, ts & "Track" & ts & TrackNo & ts)
      LibraryGrid[SearchRowIndex, Columnindex["Track"]].text = TrackNo
      'LibraryGrid[SearchRowIndex, Columnindex["Track"]].background = backcolor
   Endif
   If Comment <> ts Then
      MyRow = Replace(MyRow, ts & "Comment" & ts & GetValue(MyRow, "Comment") & ts, ts & "Comment" & ts & Comment & ts)
      LibraryGrid[SearchRowIndex, Columnindex["Comment"]].text = Comment
      'LibraryGrid[SearchRowIndex, Columnindex["Comment"]].background = backcolor
   Endif
 'Update Ptable
    Ptable[PTableRowIndex] = MyRow
    Searchtable[SearchRowIndex] = MyRow
 '  
    AlternatecolorRange(Librarygrid, SearchRowIndex, SearchRowIndex, True)
End


Public Sub Exclude(Librarygrid As Gridview, ExcludeList As Listbox)
  
  'will scan ptable (field FullPath)
  'and remove files in ExcludedList from it
  Dim i, k, numremoved, startpos, midpos, endpos As Integer
  Dim FullPathName As String
  Dim ReturnString As New String[]
  Dim Match As Boolean = False
  i = ptable.count - 1
  While i > 0
    Match = False
    i = i - 1
    Startpos = InStr(Ptable[i], TableSeparator & "Full Path")
    MidPos = InStr(Ptable[i], TableSeparator, StartPos + 1)
    EndPos = InStr(Ptable[i], TableSeparator, Midpos + 1)
    FullPathName = Mid(Ptable[i], MidPos + 1, endpos - midpos - 1)
    
    'Will filename match any excluded path?
    For k = 0 To ExcludeList.count - 1
      If (FullPathName Like (ExcludeList[k].text & "*")) Then
        Match = True
        Break
      Endif
    Next 'k
    
    
    If Match Then
      ptable.Remove(i)
      ReturnString.Add(FullPathName)
      'PRINT "Debug: PlaylistClass: Exlcude(): Removed: " & FullPathName
    Endif
  Wend
  'RETURN ReturnString
End

Public Function GetSelectedAndLength(MyPlaylist As Gridview) As String
  'returns: [SelectedItems;TotalItems;SelectedLength;TotelLength]
  Dim row As Integer
  Dim TotalItems, SelectedItems, TotalLength, SelectedLength, CurrentLength As Integer
  Dim SlenStr, TotLenStr As String
  TotalItems = myplaylist.rows.count

  If TotalItems > 0 Then
    SelectedItems = 0
    SelectedLength = 0
    TotalLength = 0
    
    For row = 0 To TotalItems - 1
      CurrentLength = MplayerTag.DeFormatTime(MyPlaylist[row, Columnindex["Length"]].Text)
      If myplaylist.Rows[row].selected Then
        SelectedItems = SelectedItems + 1
        SelectedLength = SelectedLength + CurrentLength
      Endif
        TotalLength = TotalLength + CurrentLength
    Next 'row
  Endif
  SlenStr = mplayertag.FormatTime(SelectedLength)
  TotLenStr = mplayertag.FormatTime(TotalLength)
  Return SelectedItems & ";" & TotalItems & ";" & SlenStr & ";" & TotLenStr
End


  'Fmain.Mylibrary.Exclude(Fmain.LibraryGrid, NoParseExcludedListbox)
